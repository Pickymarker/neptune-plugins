import{intercept as I}from"@neptune";import{store as x}from"@neptune";import{intercept as b}from"@neptune";var P=(i,e,a,{timeoutMs:o,cancel:n}={})=>{o??=5e3,n??=!1;let t,r,c=new Promise((p,l)=>{t=p,r=l}),s=b(e,p=>{if(t(p),n)return!0},!0),m=b(a,r,!0),u=setTimeout(()=>r(`${a}_TIMEOUT`),o);return i(),c.finally(()=>{clearTimeout(u),s(),m()})};import{store as v}from"@neptune";var d=()=>v.getState()?.playbackControls??{};var f=class{static _cache={};static current(e){if(e??=d()?.playbackContext,e?.actualProductId!==void 0)return this.ensure(e.actualProductId)}static async ensure(e){if(e===void 0)return;let a=this._cache[e];if(a!==void 0)return a;let o=x.getState().content.mediaItems;for(let n in o){let t=o[n]?.item;t?.contentType==="track"&&(this._cache[n]=t)}if(this._cache[e]===void 0){let n=window.location.pathname;await P(()=>neptune.actions.router.replace(`/track/${e}`),["page/IS_DONE_LOADING"],[]),neptune.actions.router.replace(n);let r=x.getState().content.mediaItems[+e]?.item;r?.contentType==="track"&&(this._cache[e]=r)}return this._cache[e]}};import{addUnloadable as k}from"@plugin";var w=NeptuneNative.createEvalScope(`"use strict";var neptuneExports=(()=>{var a=Object.defineProperty;var i=Object.getOwnPropertyDescriptor;var l=Object.getOwnPropertyNames;var m=Object.prototype.hasOwnProperty;var p=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,o)=>(typeof require<"u"?require:e)[o]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var x=(r,e)=>{for(var o in e)a(r,o,{get:e[o],enumerable:!0})},W=(r,e,o,b)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of l(e))!m.call(r,t)&&t!==o&&a(r,t,{get:()=>e[t],enumerable:!(b=i(e,t))||b.enumerable});return r};var c=r=>W(a({},"__esModule",{value:!0}),r);var d={};x(d,{Writable:()=>f.Writable});var f=p("stream");return c(d);})();
`),C=NeptuneNative.getNativeValue(w,"Writable");k(()=>NeptuneNative.deleteEvalScope(w));import{actions as y}from"@neptune";var g=i=>{let e=r=>{let c=(...s)=>{r(i,...s)};return c.withContext=s=>(...m)=>{r(i,s,...m)},c},a=e(console.log),o=e(console.warn),n=e(console.error),t=(r,c,s)=>{let m=u=>{r(u),c({message:`${i} - ${u}`,category:"OTHER",severity:s})};return m.withContext=u=>{let p=r.withContext(u);return l=>{p(l),l instanceof Error&&(l=l.message),c({message:`${i}.${u} - ${l}`,category:"OTHER",severity:s})}},m};return{log:a,warn:o,err:n,msg:{log:t(a,y.message.messageInfo,"INFO"),warn:t(o,y.message.messageWarn,"WARN"),err:t(n,y.message.messageError,"ERROR")}}},$=g("[lib]");var h=g("[NoBuffer]"),T=!1,K=I("playbackControls/SET_PLAYBACK_STATE",([i])=>{let{playbackContext:e,latestCurrentTime:a}=d();(a??0)>5&&i==="STALLED"&&T===!1&&(T=!0,(async()=>{if(e===void 0)return;let o=await f.current(e);if(o===void 0)return;h.msg.log(`Playback stalled for ${o?.title} - Kicking tidal CDN`);let n=new C({write:(t,r,c)=>c()});await new Promise(t=>n.on("end",t)),T=!1})())});export{K as onUnload};
